"use strict";(self.webpackChunkgds_bootcamp=self.webpackChunkgds_bootcamp||[]).push([[1146],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>m});var n=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=n.createContext({}),c=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(r),m=o,h=d["".concat(l,".").concat(m)]||d[m]||p[m]||a;return r?n.createElement(h,i(i({ref:t},u),{},{components:r})):n.createElement(h,i({ref:t},u))}));function m(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=r[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},2322:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var n=r(7462),o=(r(7294),r(3905));const a={},i="4.0 Deploying with IaC",s={unversionedId:"infrastructure/Infrastructure-Setup",id:"infrastructure/Infrastructure-Setup",title:"4.0 Deploying with IaC",description:"Infrastructure as code is the process of provisioning and managing your cloud resources by writing a template file that is both human readable, and machine consumable. Compared to using graphical user interface which may not be maintainable and extensible, which makes cleaning up very tedious as well. For AWS cloud development the built-in choice for infrastructure as code is AWS CloudFormation.",source:"@site/docs/infrastructure/40-Infrastructure-Setup.md",sourceDirName:"infrastructure",slug:"/infrastructure/Infrastructure-Setup",permalink:"/docs/infrastructure/Infrastructure-Setup",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/infrastructure/40-Infrastructure-Setup.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"4. Infrastructure as Code",permalink:"/docs/category/4-infrastructure-as-code"},next:{title:"4.1 VPC and Subnets",permalink:"/docs/infrastructure/VPC-Subnets"}},l={},c=[{value:"Why use Infrastructure as Code",id:"why-use-infrastructure-as-code",level:2},{value:"Introduction to AWS Cloudformation Template",id:"introduction-to-aws-cloudformation-template",level:3},{value:"Resources",id:"resources",level:4},{value:"Property",id:"property",level:4},{value:"Ref",id:"ref",level:4},{value:"Output",id:"output",level:4},{value:"Import",id:"import",level:4},{value:"Instructions",id:"instructions",level:4}],u={toc:c};function p(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"40-deploying-with-iac"},"4.0 Deploying with IaC"),(0,o.kt)("p",null,"Infrastructure as code is the process of provisioning and managing your cloud resources by writing a template file that is both human readable, and machine consumable. Compared to using graphical user interface which may not be maintainable and extensible, which makes cleaning up very tedious as well. For AWS cloud development the built-in choice for infrastructure as code is AWS CloudFormation."),(0,o.kt)("p",null,"List of IAC Tools:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"AWS Cloudformation (We will be using this!)"),(0,o.kt)("li",{parentName:"ol"},"Terraform"),(0,o.kt)("li",{parentName:"ol"},"Ansible"),(0,o.kt)("li",{parentName:"ol"},"Chef"),(0,o.kt)("li",{parentName:"ol"},"Puppet")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"why-use-infrastructure-as-code"},"Why use Infrastructure as Code"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Visibility"),": An infrastructure as code template serves as a very clear reference of what resources are on your account, and what their settings are. You don\u2019t have to navigate to the web console to check the parameters."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Stability"),": If you accidentally change the wrong setting or delete the wrong resource in the web console you can break things. Infrastructure as code helps solve this, especially when it is combined with version control, such as Git."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Scalability"),": With infrastructure as code you can write it once and then reuse it many times. This means that one well written template can be used as the basis for multiple services, in multiple regions around the world, making it much easier to horizontally scale."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Security"),": Once again infrastructure as code gives you a unified template for how to deploy your architecture. If you create one well secured architecture you can reuse it multiple times, and know that each deployed version is following the same settings."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Transactional"),": CloudFormation not only creates resources on your AWS account but also waits for them to stabilize while they start. It verifies that provisioning was successful, and if there is a failure it can gracefully roll the infrastructure back to a past known good state.1.")),(0,o.kt)("h3",{id:"introduction-to-aws-cloudformation-template"},"Introduction to AWS Cloudformation Template"),(0,o.kt)("h4",{id:"resources"},"Resources"),(0,o.kt)("p",null,"The Resources object contains a list of resource objects. A resource declaration contains the resource's attributes, which are themselves declared as child objects. A resource must have a Type attribute, which defines the kind of AWS resource you want to create. The Type attribute has a special format:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"AWS::ProductIdentifier::ResourceType\n")),(0,o.kt)("p",null,"Example of a Cloudformation template to provision an S3 bucket resource"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Resources:\n  MyBucket:\n    Type: 'AWS::S3::Bucket'\n")),(0,o.kt)("h4",{id:"property"},"Property"),(0,o.kt)("p",null,"Depending on the resource type, some properties are required, such as the ImageId property for an AWS::EC2::Instance resource, and others are optional."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Resources:\n  MyBucket:\n    Type: 'AWS::S3::Bucket'\n    Properties:\n      AccessControl: PublicRead\n")),(0,o.kt)("h4",{id:"ref"},"Ref"),(0,o.kt)("p",null,"You're probably wondering how you set properties on one resource based on the name or property of another resource. For example, an EC2 resource that uses a Security Group resource. This is where Ref function is used to ",(0,o.kt)("strong",{parentName:"p"},"refer")," to an identifying property of a reource"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Resources:\n  Ec2Instance:\n    Type: 'AWS::EC2::Instance'\n    Properties:\n      SecurityGroups:\n        - !Ref InstanceSecurityGroup\n      KeyName: mykey\n      ImageId: ''\n  InstanceSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: Enable SSH access via port 22\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 22\n          ToPort: 22\n          CidrIp: 0.0.0.0/0\n")),(0,o.kt)("h4",{id:"output"},"Output"),(0,o.kt)("p",null,"The Outputs object in the template contains declarations for the values that you want to have available after the stack is created. An output is a convenient way to capture important information about your resources or input parameters. This also means that these output values are visible and can be referenced by other stacks."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"LoadBalancerListener:\n    Description: listener port 80\n    Value: !Ref PublicLoadBalancerListener\n    Export:\n      Name: 'PublicLoadBalancerListener'\n")),(0,o.kt)("h4",{id:"import"},"Import"),(0,o.kt)("p",null,"The intrinsic function Fn::ImportValue returns the value of an output exported by another stack. You typically use this function to create cross-stack references. In the following example template snippets, Stack A exports VPC security group values and Stack B imports them."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ListenerRule:\n    Type: AWS::ElasticLoadBalancingV2::ListenerRule\n    Properties:\n      ListenerArn: !ImportValue PublicLoadBalancerListener\n      Priority: 2\n      Conditions:\n        - Field: path-pattern\n          Values:\n            - /*\n      Actions:\n        - TargetGroupArn: !Ref TargetGroup\n          Type: forward\n")),(0,o.kt)("h4",{id:"instructions"},"Instructions"),(0,o.kt)("p",null,"With the above information, we can start writing our own Cloudformation Template.\nWe will be making use of the infrastructure repository. If you have not done so already, you can run the following command to clone the infrastructure templates into your folder."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://gitlab.com/<your-group-name>/infrastructure.git\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The infrastructure folder consist of 4 parts"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"role-policies.yml: Provison ECS access roles"),(0,o.kt)("li",{parentName:"ul"},"vpc-subnets.yml: Provision VPC and Subnets"),(0,o.kt)("li",{parentName:"ul"},"ecs-cluster.yml: Provision ECS cluster"),(0,o.kt)("li",{parentName:"ul"},"ecs-containers.yml: Provision ECS task definitions"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Have a look at the role and policies. This cloudformation template will be used to create new roles and give it the permission for ECS to fetch images and log sending. This will be attached to ECS later in the tutorial."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"AWSTemplateFormatVersion: '2010-09-09'\nDescription: roles and policies\n\nResources:\n  ECSTaskExecutionRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Statement:\n        - Effect: Allow\n          Principal:\n            Service: [ecs-tasks.amazonaws.com]\n          Action: ['sts:AssumeRole']\n      Path: /\n      Policies:\n        - PolicyName: AmazonECSTaskExecutionRolePolicy\n          PolicyDocument:\n            Statement:\n            - Effect: Allow\n              Action:\n                # ECS Tasks to download images from ECR\n                - 'ecr:GetAuthorizationToken'\n                - 'ecr:BatchCheckLayerAvailability'\n                - 'ecr:GetDownloadUrlForLayer'\n                - 'ecr:BatchGetImage'\n                # ECS tasks to upload logs to CloudWatch\n                - 'logs:CreateLogStream'\n                - 'logs:PutLogEvents'\n              Resource: '*'\n\nOutputs:\n\n  ECSTaskExecutionRole:\n    Description: ECS Task Execution Role\n    Value: !GetAtt 'ECSTaskExecutionRole.Arn'\n    Export:\n      Name: 'ECSTaskExecutionRole'\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Now we will upload this template to Cloudformation. Please access to your aws console and upload your template. ")),(0,o.kt)("p",null,"On the top right panel of your console, select ",(0,o.kt)("inlineCode",{parentName:"p"},"Create Stack"),".\n",(0,o.kt)("img",{alt:"Create Stack",src:r(2350).Z,title:"Create Stack",width:"2798",height:"530"}),"\nUnder the specify template, upload the ",(0,o.kt)("inlineCode",{parentName:"p"},"role-policies.yml")," template file.\n",(0,o.kt)("img",{alt:"Upload template",src:r(4855).Z,title:"Upload template",width:"2054",height:"1310"}),"\nGive your stack a name and select Next, leave the default settings.\nThis should kick of the resource provisioning process.\n",(0,o.kt)("img",{alt:"Provision Process",src:r(2535).Z,title:"Provision Process",width:"1724",height:"1268"}),"\nYou may look into IAM role on AWS to validate the role created from your template"),(0,o.kt)("hr",null))}p.isMDXComponent=!0},2350:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/cf-creation-1-f8ea9b522e5341a4111ba1b3c8f2694a.png"},4855:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/cf-creation-2-8c5769e64db6130ea9aacc61cd581da8.png"},2535:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/cf-creation-3-c5ef42afd5733f5b60ee51acd5f42e0c.png"}}]);